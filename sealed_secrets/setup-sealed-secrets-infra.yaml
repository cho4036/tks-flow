apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: setup-sealed-secrets-infra
  namespace: argo
spec:
  entrypoint: process
  arguments:
    parameters:
    - name: contract_id
      value: "011b88fa-4d53-439f-9336-67845f994051"
    - name: cluster_id
      value: ""
    - name: git_account
      value: "tks-management"
    # For cluster selection in Argo CD #
    - name: tks_admin
      value: "tks-admin"
    - name: app_group
      value: "sealed-secrets"
    - name: revision
      value: "main"
## Uncomment following lines if you need to customize these ##
#    - name: master_key_repo_url
#      value: "github.com/openinfradev/tks-admin-site"
#    - name: master_key_secret_name
#      value: "github.com/openinfradev/tks-admin-site"
#    - name: sealed_secrets_repo_url
#      value: "github.com/openinfradev/tks-admin-site"
#      ...
##############################################################
  templates:
  - name: process
    steps:
    - - name: deployMasterKey
        templateRef:
          name: deploy-secrets
          template: deploySecrets
        arguments:
          parameters:
          # In case of user cluster, repo url should be constructed from parameters
          # such as git_account, contract id & cluster id.
          - name: repo_url
            value: "github.com/openinfradev/tks-admin-site"
          - name: secret_path
            value: "sealed-secret-key/master-key-secret.yaml"
          - name: kubeconfig_secret_name
            value: "{{workflow.parameters.cluster_id}}-kubeconfig"

    - - name: installControllers
        templateRef:
          name: tks-create-application
          template: installAppsOnAdmin
        arguments:
          parameters:
          - name: list
            value: |
              [
                 { "path": “sealed-secret-controller", "namespace": “kube-system” },
                 { "path": “kubed", "namespace": “kube-system” }
              ]

    - - name: deploySealedSecret
        templateRef:
          name: deploy-secrets
          template: deploySecrets
        arguments:
          parameters:
          - name: repo_url
            value: "github.com/openinfradev/tks-admin-site"
          - name: secret_path
            value: "sealed-certificates/taco-cat-tls-sealed.yaml"
          - name: kubeconfig_secret_name
            value: "{{workflow.parameters.cluster_id}}-kubeconfig"
